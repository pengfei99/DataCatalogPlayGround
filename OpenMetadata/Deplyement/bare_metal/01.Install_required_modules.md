# Install openmeta data on bare metal

This tutorial is tested on `debian 11` with OM `v1.9.x`.

## Step1: Install java (version 21 or higher)

OpenMetadata is built using `Java, DropWizard, and Jetty`.

Type the following command to verify that you have a supported version of the Java runtime installed.

Install openjdk 21, you can change the url for another version of jdk. Please visit this [site](https://jdk.java.net/) for more info

```shell
wget https://download.java.net/java/GA/jdk21.0.2/f2283984656d49d69e91c558476027ac/13/GPL/openjdk-21.0.2_linux-x64_bin.tar.gz

tar -xzvf openjdk-21.0.2_linux-x64_bin.tar.gz

sudo mkdir /opt/java

sudo mv jdk-21.0.2 /opt/java

sudo vim /etc/profile.d/java.sh
# add the below lines
export JAVA_HOME=/opt/java/jdk-21.0.2
export PATH=$PATH:$JAVA_HOME/bin

source /etc/profile.d/java.sh
```
Now you can check if the 
```shell
java --version

# echo the JAVA_HOME
echo $JAVA_HOME
```

## Step2: Install postgresql

The official installation doc is [here](https://www.postgresql.org/download/linux/debian/)

```shell
# as the default version is too old, we add the official repo manually to the apt
# Import the repository signing key:
sudo apt install curl ca-certificates
sudo install -d /usr/share/postgresql-common/pgdg
sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc

# Create the repository configuration file:
# . is a shortcut for source
. /etc/os-release
sudo sh -c "echo 'deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $VERSION_CODENAME-pgdg main' > /etc/apt/sources.list.d/pgdg.list"

# Update the package lists:
sudo apt update

# Install the latest version of PostgreSQL:
# If you want a specific version, use 'postgresql-17' or similar instead of 'postgresql'
sudo apt -y install postgresql

# install the postgresql cli
sudo apt -y install postgresql-client

# start the service
sudo systemctl start postgresql
sudo systemctl enable postgresql

# check the installed version
sudo -u postgres psql -c "SELECT version();"
```

### 2.1 Change default password of postgres

```shell
# open a postgres shell with uid postgres
sudo -u postgres psql
# in the postgres shell run the below command
ALTER USER postgres PASSWORD 'YourPassword';
# exit
QUIT;
```

### 2.2 Change listening port

```shell
sudo vim /etc/postgresql/17/main/postgresql.conf

# activate this line
listen_addresses = '*' 
```

### 2.3. Change ACL

```shell
# open the acl config file
sudo vim /etc/postgresql/17/main/pg_hba.conf

# add below line to allow remote connection via password
host    all             all             0.0.0.0/0            md5
```

> You need to restart the postgres server `sudo systemctl restart postgresql` to apply change 
> 
> 
### 2.4 configure postgres for OM
You need to run the below sql script 
```sql
CREATE DATABASE openmetadata_db;
CREATE DATABASE airflow_db;
CREATE USER openmetadata_user WITH PASSWORD 'openmetadata_password';
CREATE USER airflow_user WITH PASSWORD 'airflow_pass';
ALTER DATABASE openmetadata_db OWNER TO openmetadata_user;
ALTER DATABASE airflow_db OWNER TO airflow_user;
ALTER USER airflow_user SET search_path = public;
commit;
```
## Step3: Install the elasticsearch (version 8.x)

The official elastic install doc is [here](https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html)

At the time, the latest stable version is `8.14`. So the below instruction works for installing `es 8.14` in debian 11.

```shell
# import the PGP key
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg

# Add the el repo to source.list.d
echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list

# update repo and install elasticsearch
sudo apt-get update
sudo apt-get install elasticsearch

# after the above command, you will see many outputs, the generated password for the root user `elastic` is in it too.
# if you want to change it, you can run the below command
/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic

# this will generate a new password
# we recommend you to add this password to your session with the below command
export ELASTIC_PASSWORD="your_password" 

# start the elastic search service
sudo systemctl daemon-reload
sudo systemctl start elasticsearch.service

# enable the service at boot
sudo systemctl enable elasticsearch.service

sudo systemctl stop elasticsearch.service

# you can check the service status
sudo systemctl status elasticsearch.service

# check the journal
sudo journalctl --unit elasticsearch --since  "2024-06-10 18:17:16"
```

> we do not use the `add-apt-repository`, because it edits the original system `sources.list`. We prefer to create a new file
> `add-apt-repository` is not part of the default install for many linux distribution.

### 3.1 Test the elastic service

To test the elastic service, export the user password of elastic, then run the below command
You may need the sudo right to access the certificate `/etc/elasticsearch/certs/http_ca.crt`.

```shell
export ELASTIC_PASSWORD="your_password" 
sudo curl --cacert /etc/elasticsearch/certs/http_ca.crt -u elastic:$ELASTIC_PASSWORD https://localhost:9200 

# You should see the below ouput
{
  "name" : "openmetada.casd.local",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "Y-kmMIp6SZ6KEl9zfzXdVg",
  "version" : {
    "number" : "8.14.0",
    "build_flavor" : "default",
    "build_type" : "deb",
    "build_hash" : "8d96bbe3bf5fed931f3119733895458eab75dca9",
    "build_date" : "2024-06-03T10:05:49.073003402Z",
    "build_snapshot" : false,
    "lucene_version" : "9.10.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}

```

### 3.2 Configuring Elasticsearch

The **/etc/elasticsearch** directory contains the default runtime configuration for Elasticsearch. The ownership of 
this directory and all contained files are set to `root:elasticsearch` on package installations.

The `setgid` flag applies group permissions on the `/etc/elasticsearch` directory to ensure that Elasticsearch can 
read any contained files and subdirectories. All files and subdirectories inherit the `root:elasticsearch` ownership. 
Running commands from this directory or any subdirectories, such as the `elasticsearch-keystore` tool, requires 
`root:elasticsearch` permissions.

Elasticsearch loads its configuration from the `/etc/elasticsearch/elasticsearch.yml` file by default. The format of 
this config file is explained in [Configuring Elasticsearch](https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html).

The Debian package also has a system configuration file (`/etc/default/elasticsearch`), which allows you to set the following parameters:

- **ES_JAVA_HOME**: Set a custom Java path to be used.
- **ES_PATH_CONF**: Configuration file directory (which needs to include elasticsearch.yml, jvm.options, and log4j2.properties files); 
                 defaults to `/etc/elasticsearch`.
- **ES_JAVA_OPTS**: Any additional JVM system properties you may want to apply.
- **RESTART_ON_UPGRADE**: Configure restart on package upgrade, defaults to `false`. This means you will have to restart 
                       your Elasticsearch instance after installing a package manually. The reason for this is to 
                       ensure, that upgrades in a cluster do not result in a continuous shard reallocation resulting
                      in high network traffic and reducing the response times of your cluster.


### 3.4 Trouble shoot duplicate entries for el repo

If you have the following error: `Duplicate sources.list entry https://artifacts.elastic.co/packages/8.x/apt/ ...`. You
need to examine `/etc/apt/sources.list.d/elasticsearch-8.x.list` for the duplicate entry or locate the duplicate 
entry amongst the files in `/etc/apt/sources.list.d/` and the `/etc/apt/sources.list` file.

### 3.5 Work with el default security

When installing Elasticsearch, security features are enabled and configured by default. When you install Elasticsearch, 
the following security configuration occurs automatically:

- Authentication and authorization are enabled, and a password is generated for the elastic built-in superuser.
- Certificates and keys for TLS are generated for the transport and HTTP layer, and TLS is enabled and configured with these keys and certificates.

You can find three import files in `/etc/elasticsearch/certs`
- **http_ca.crt**: The CA certificate that is used to sign the certificates for the HTTP layer of this Elasticsearch cluster.
- **http.p12**: Keystore that contains the key and certificate for the HTTP layer for this node.
- **transport.p12**: Keystore that contains the key and certificate for the transport layer for all the nodes in your cluster.

> The keystore is password protected, you can use the below command to get the password
> 
```shell

# Use the following command to retrieve the password for http.p12:
sudo /usr/share/elasticsearch/bin/elasticsearch-keystore show xpack.security.http.ssl.keystore.secure_password

# Use the following command to retrieve the password for transport.p12
sudo /usr/share/elasticsearch/bin/elasticsearch-keystore show xpack.security.transport.ssl.keystore.secure_password
```
### 3.6 Disable ssl/tls

For test, you may need to disable the ssl/tls. 

In **/etc/elasticsearch/elasticsearch.yml**, you can find all config of the elasticsearch

```shell
# Find the following lines related to SSL/TLS configuration:
xpack.security.transport.ssl.enabled: true
xpack.security.http.ssl.enabled: true

# Change the values from `true` to `false`:
xpack.security.transport.ssl.enabled: false
xpack.security.http.ssl.enabled: false

# Then restart the service
sudo systemctl restart elasticsearch

# test it with http
curl -u elastic:$ELASTIC_PASSWORD http://localhost:9200
```

## 4. Install airflow

Check the installation doc here: https://github.com/pengfei99/WorkflowPlayGround/tree/main/airflow/docs